<div class="history-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon class="title-icon">history</mat-icon>
        Email History
      </h1>
      <p class="page-subtitle">
        Track and manage all sent emails with real-time status updates
      </p>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="primary" class="export-btn" (click)="exportHistory()">
        <mat-icon>download</mat-icon>
        Export History
      </button>
      <button mat-stroked-button class="refresh-btn" (click)="loadEmailHistory()">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="stats-overview">
    <div class="stat-item">
      <div class="stat-icon total">
        <mat-icon>email</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ emailHistory.length }}</div>
        <div class="stat-label">Total Emails</div>
      </div>
    </div>
    <div class="stat-item">
      <div class="stat-icon delivered">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ deliveredCount }}</div>
        <div class="stat-label">Delivered</div>
      </div>
    </div>
    <div class="stat-item">
      <div class="stat-icon sent">
        <mat-icon>send</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ sentCount }}</div>
        <div class="stat-label">Sent</div>
      </div>
    </div>
    <div class="stat-item">
      <div class="stat-icon failed">
        <mat-icon>error</mat-icon>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ failedCount }}</div>
        <div class="stat-label">Failed</div>
      </div>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="filters-section">
    <div class="search-box">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search emails</mat-label>
        <input matInput placeholder="Search by employee, subject, or email..." [(ngModel)]="searchTerm">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
    <div class="filter-controls">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Status</mat-label>
        <mat-select [(ngModel)]="statusFilter">
          <mat-option *ngFor="let option of statusOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-stroked-button class="clear-filters-btn" (click)="clearFilters()">
        <mat-icon>clear</mat-icon>
        Clear Filters
      </button>
    </div>
  </div>

  <!-- Email History Table -->
  <div class="table-container">
    <div class="table-header">
      <h3 class="table-title">Email History</h3>
      <div class="table-actions">
        <button mat-button color="primary" class="bulk-action-btn" (click)="showBulkActions()">
          <mat-icon>more_vert</mat-icon>
          Bulk Actions
        </button>
      </div>
    </div>
    
    <div class="table-wrapper">
      <table mat-table [dataSource]="emailHistory" class="history-table">
        <!-- Employee Column -->
        <ng-container matColumnDef="employee">
          <th mat-header-cell *matHeaderCellDef>Employee</th>
          <td mat-cell *matCellDef="let email">
            <div class="employee-info">
              <div class="avatar" [class]="email.status">
                {{ email.employeeName.charAt(0) }}
              </div>
              <div class="employee-details">
                <div class="employee-name">{{ email.employeeName }}</div>
                <div class="employee-email">{{ email.toEmail }}</div>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Subject Column -->
        <ng-container matColumnDef="subject">
          <th mat-header-cell *matHeaderCellDef>Subject</th>
          <td mat-cell *matCellDef="let email">
            <div class="subject-info">
              <div class="subject-text">{{ email.subject }}</div>
              <div class="letter-type">{{ email.letterType }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let email">
            <div class="status-container">
              <mat-chip [color]="getStatusColor(email.status)" selected class="status-chip">
                <mat-icon class="status-icon">{{ getStatusIcon(email.status) }}</mat-icon>
                {{ email.status }}
              </mat-chip>
              <div class="status-details" *ngIf="email.errorMessage">
                <mat-icon class="error-icon">error</mat-icon>
                <span class="error-text">{{ email.errorMessage }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Sent Date Column -->
        <ng-container matColumnDef="sentDate">
          <th mat-header-cell *matHeaderCellDef>Sent Date</th>
          <td mat-cell *matCellDef="let email">
            <div class="date-info">
              <div class="date-text">{{ formatDate(email.sentAt) }}</div>
              <div class="time-ago">{{ getTimeAgo(email.sentAt) }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Attachments Column -->
        <ng-container matColumnDef="attachments">
          <th mat-header-cell *matHeaderCellDef>Attachments</th>
          <td mat-cell *matCellDef="let email">
            <div class="attachments-info">
              <div class="attachment-count" *ngIf="email.attachments.length > 0">
                <mat-icon class="attachment-icon">attach_file</mat-icon>
                {{ email.attachments.length }} file(s)
              </div>
              <div class="no-attachments" *ngIf="email.attachments.length === 0">
                No attachments
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let email">
            <button mat-icon-button [matMenuTriggerFor]="menu" class="action-btn">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="viewEmailDetails(email)">
                <mat-icon>visibility</mat-icon>
                <span>View Details</span>
              </button>
              <button mat-menu-item (click)="resendEmail(email)" 
                      [disabled]="email.status === 'pending'">
                <mat-icon>send</mat-icon>
                <span>Resend</span>
              </button>
              <button mat-menu-item (click)="downloadAttachments(email)" 
                      *ngIf="email.attachments.length > 0">
                <mat-icon>download</mat-icon>
                <span>Download Attachments</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['employee', 'subject', 'status', 'sentDate', 'attachments', 'actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['employee', 'subject', 'status', 'sentDate', 'attachments', 'actions'];" 
            class="history-row"
            [class]="row.status">
        </tr>
      </table>
    </div>

    <!-- Pagination -->
    <mat-paginator [pageSizeOptions]="pageSizeOptions" 
                   [pageSize]="pageSize"
                   [length]="totalItems"
                   [pageIndex]="currentPage"
                   (page)="onPageChange($event)"
                   showFirstLastButtons 
                   class="pagination">
    </mat-paginator>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <mat-spinner diameter="40"></mat-spinner>
    <span class="loading-text">Loading email history...</span>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!isLoading && emailHistory.length === 0">
    <mat-icon class="empty-icon">history</mat-icon>
    <h3>No email history found</h3>
    <p>Send your first email to see it appear here</p>
    <button mat-raised-button color="primary" class="generate-first-btn" routerLink="/generate">
      <mat-icon>create</mat-icon>
      Generate Letter
    </button>
  </div>
</div>
